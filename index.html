<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>作業ペース計測</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a2a66">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
  --bg:#0a2a66;
  --fg:#ffffff;
  --muted:rgba(255,255,255,.8);
  --line:rgba(255,255,255,.55);
  --btn-bg:#ffffff;
  --btn-fg:#0a2a66;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
}

.wrap{
  min-height:100vh;
  padding:max(16px, env(safe-area-inset-top)) 12px max(16px, env(safe-area-inset-bottom));
  display:flex;
  flex-direction:column;
  gap:16px;
}

.big-label{
  font-size:clamp(20px,5vw,28px);
  font-weight:500;
  color:var(--muted);
}
.big-time{
  font-size:clamp(48px,14vw,68px);
  font-weight:900;
  line-height:1.08;
  white-space:nowrap;
  font-variant-numeric:tabular-nums;
}
.divider{
  height:2px;
  background:var(--line);
  width:100%;
  margin-top:6px;
}

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.label{
  font-size:clamp(17px,4.5vw,26px);
  font-weight:500;
  color:var(--muted);
  white-space:nowrap;
}
.value{
  width:100%;
  text-align:right;
  font-size:clamp(28px,7vw,40px);
  font-weight:800;
  color:var(--fg);
  background:transparent;
  border:none;
  border-bottom:2px solid var(--line);
  padding-bottom:4px;
  outline:none;
}

.section-title{
  font-size:clamp(22px,5.5vw,32px);
  font-weight:600;
  color:var(--muted);
}
.eta{
  font-size:clamp(52px,15vw,84px);
  font-weight:900;
  line-height:1;
  white-space:nowrap;
  font-variant-numeric:tabular-nums;
}

/* Wake Lock */
.wake-line{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
  color:var(--muted);
  font-size:clamp(14px,3.8vw,18px);
  white-space:nowrap;
}
.wake-btn{
  border:none;
  border-radius:999px;
  padding:8px 14px;
  font-weight:900;
  background:#fff;
  color:var(--btn-fg);
}
.wake-btn.on{ background:#fff; }
.wake-msg{ opacity:.8; }

/* ボタン */
.btns{
  display:flex;
  gap:12px;
}
button{
  flex:1;
  border:none;
  border-radius:16px;
  padding:16px 0;
  font-size:clamp(18px,5vw,28px);
  font-weight:800;
  background:#fff;
  color:var(--btn-fg);
}
button:disabled{ opacity:.6; }

/* ログ */
.log-title{
  color:var(--muted);
  font-size:clamp(14px,3.8vw,18px);
  font-weight:600;
}
.log-box{
  margin-top:6px;
  border:2px solid rgba(255,255,255,.35);
  border-radius:14px;
  padding:10px 12px;
  color:rgba(255,255,255,.92);
  font-size:clamp(12px,3.3vw,15px);
  line-height:1.45;
  font-variant-numeric:tabular-nums;
  white-space:pre-line;
  user-select:text;

  max-height:28vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.log-empty{ opacity:.8; }
</style>
</head>

<body>
<div class="wrap">

  <div>
    <div class="big-label">所要時間</div>
    <div id="elapsed" class="big-time">00:00:00</div>
    <div class="divider"></div>
  </div>

  <div class="field">
    <div class="label">ロット数（1ロットあたりの個数）</div>
    <input id="lotCount" class="value" type="number" min="1" value="20">
  </div>
  <div class="divider"></div>

  <div class="field">
    <div class="label">本日のノルマ（合計個数）</div>
    <input id="targetCount" class="value" type="number" min="1" value="1000">
  </div>
  <div class="divider"></div>

  <div>
    <div class="section-title">予測完了時間</div>
    <div id="pred" class="eta">00:00:00</div>

    <div class="wake-line">
      画面ON維持：
      <button id="wakeBtn" class="wake-btn">OFF</button>
      <span id="wakeMsg" class="wake-msg"></span>
    </div>

    <div class="divider"></div>
  </div>

  <div class="btns">
    <button id="startBtn">スタート</button>
    <button id="stopBtn" disabled>ストップ</button>
    <button id="resetBtn">リセット</button>
  </div>

  <div class="divider"></div>

  <div>
    <div class="log-title">ログ</div>
    <div id="logBox" class="log-box log-empty">（まだありません）</div>
  </div>

</div>

<script>
(() => {
  const STORE_KEY = "work_pace_state_v3";

  let running=false,startMs=0,elapsedMs=0,timer=null;
  let segmentStartMs=null;
  let segments=[];

  const elapsedEl=document.getElementById('elapsed');
  const predEl=document.getElementById('pred');
  const lotEl=document.getElementById('lotCount');
  const targetEl=document.getElementById('targetCount');
  const startBtn=document.getElementById('startBtn');
  const stopBtn=document.getElementById('stopBtn');
  const resetBtn=document.getElementById('resetBtn');
  const wakeBtn=document.getElementById('wakeBtn');
  const wakeMsg=document.getElementById('wakeMsg');
  const logBox=document.getElementById('logBox');

  const pad=n=>String(n).padStart(2,'0');

  function fmtHMS(ms){
    const s=Math.floor(ms/1000);
    return `${pad(Math.floor(s/3600))}:${pad(Math.floor(s/60)%60)}:${pad(s%60)}`;
  }

  /* ★ 秒まで含めたログ用書式 */
  function fmtStamp(ts){
    const d=new Date(ts);
    return `${pad(d.getMonth()+1)}/${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function fmtSegment(seg){
    const s=fmtStamp(seg.start);
    if(seg.end==null) return `${s}–…（計測中）`;
    return `${s}–${fmtStamp(seg.end)}`;
  }

  function currentElapsedMs(){
    return running ? elapsedMs+(Date.now()-startMs) : elapsedMs;
  }

  function renderLog(){
    if(!segments.length){
      logBox.textContent="（まだありません）";
      logBox.classList.add("log-empty");
      return;
    }
    logBox.textContent=segments.map(fmtSegment).join("\n");
    logBox.classList.remove("log-empty");
  }

  function render(){
    const cur=currentElapsedMs();
    elapsedEl.textContent=fmtHMS(cur);
    const lot=Math.max(1,Number(lotEl.value)||1);
    const tgt=Math.max(0,Number(targetEl.value)||0);
    predEl.textContent=fmtHMS(Math.ceil(cur*tgt/lot));
    renderLog();
  }

  function save(){
    localStorage.setItem(STORE_KEY,JSON.stringify({
      lot:lotEl.value,target:targetEl.value,
      elapsedMs:currentElapsedMs(),running,
      savedAt:Date.now(),
      segmentStartMs,segments
    }));
  }

  function load(){
    const s=JSON.parse(localStorage.getItem(STORE_KEY)||"null");
    if(!s) return;
    lotEl.value=s.lot||lotEl.value;
    targetEl.value=s.target||targetEl.value;
    elapsedMs=s.elapsedMs||0;
    segments=Array.isArray(s.segments)?s.segments:[];
    if(s.running){
      elapsedMs+=Math.max(0,Date.now()-s.savedAt);
      running=true;startMs=Date.now();
      if(s.segmentStartMs && !(segments.at(-1)?.end==null))
        segments.push({start:s.segmentStartMs,end:null});
    }
  }

  function start(){
    if(running) return;
    running=true;startMs=Date.now();
    segmentStartMs=Date.now();
    segments.push({start:segmentStartMs,end:null});
    stopBtn.disabled=false;startBtn.disabled=true;
    timer=setInterval(()=>{render();save();},200);
    save();
  }
  function stop(){
    if(!running) return;
    elapsedMs=currentElapsedMs();
    segments.at(-1).end=Date.now();
    running=false;segmentStartMs=null;
    clearInterval(timer);
    startBtn.disabled=false;stopBtn.disabled=true;
    render();save();
  }
  function reset(){
    running=false;elapsedMs=0;segmentStartMs=null;
    clearInterval(timer);
    startBtn.disabled=false;stopBtn.disabled=true;
    render();save();
  }

  startBtn.onclick=start;
  stopBtn.onclick=stop;
  resetBtn.onclick=reset;
  lotEl.oninput=()=>{save();render();};
  targetEl.oninput=()=>{save();render();};

  load();render();
})();
</script>

</body>
</html>