<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>作業ペース計測</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a2a66">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
  --bg:#0a2a66;
  --fg:#ffffff;
  --muted:rgba(255,255,255,.8);
  --line:rgba(255,255,255,.55);
  --btn-bg:#ffffff;
  --btn-fg:#0a2a66;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
}
.wrap{
  min-height:100vh;
  padding:max(16px, env(safe-area-inset-top)) 12px max(16px, env(safe-area-inset-bottom));
  display:flex;
  flex-direction:column;
  gap:16px;
}
.big-label{
  font-size:clamp(20px,5vw,28px);
  font-weight:500;
  color:var(--muted);
}
.big-time{
  font-size:clamp(48px,14vw,68px);
  font-weight:900;
  line-height:1.08;
  white-space:nowrap;
  font-variant-numeric:tabular-nums;
}
.divider{
  height:2px;
  background:var(--line);
  width:100%;
  margin-top:6px;
}
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.label{
  font-size:clamp(17px,4.5vw,26px);
  font-weight:500;
  color:var(--muted);
  white-space:nowrap;
}
.value{
  width:100%;
  text-align:right;
  font-size:clamp(28px,7vw,40px);
  font-weight:800;
  color:var(--fg);
  background:transparent;
  border:none;
  border-bottom:2px solid var(--line);
  padding-bottom:4px;
  outline:none;
}
.section-title{
  font-size:clamp(22px,5.5vw,32px);
  font-weight:600;
  color:var(--muted);
}
.eta{
  font-size:clamp(52px,15vw,84px);
  font-weight:900;
  line-height:1;
  white-space:nowrap;
  font-variant-numeric:tabular-nums;
}

.btns{
  margin-top:auto;
  display:flex;
  gap:12px;
}
button{
  flex:1;
  border:none;
  border-radius:16px;
  padding:16px 0;
  font-size:clamp(18px,5vw,28px);
  font-weight:800;
  background:var(--btn-bg);
  color:var(--btn-fg);
}
button:disabled{ opacity:.6; }

/* --- Wake Lock UI --- */
.wake-line{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
  color: var(--muted);
  font-size: clamp(14px, 3.8vw, 18px);
  white-space: nowrap;
}
.wake-btn{
  flex: none;
  border:none;
  border-radius:999px;
  padding:8px 14px;
  font-size: inherit;
  font-weight: 900;
  background: rgba(255,255,255,.92);
  color: var(--btn-fg);
}
.wake-btn.on{
  background: rgba(255,255,255,1);
}
.wake-msg{
  opacity:.85;
  font-size: 0.95em;
}
</style>
</head>

<body>
<div class="wrap">

  <div>
    <div class="big-label">所要時間</div>
    <div id="elapsed" class="big-time">00:00:00</div>
    <div class="divider"></div>
  </div>

  <div class="field">
    <div class="label">ロット数（1ロットあたりの個数）</div>
    <input id="lotCount" class="value" type="number" min="1" value="20" inputmode="numeric">
  </div>
  <div class="divider"></div>

  <div class="field">
    <div class="label">本日のノルマ（合計個数）</div>
    <input id="targetCount" class="value" type="number" min="1" value="1000" inputmode="numeric">
  </div>
  <div class="divider"></div>

  <div>
    <div class="section-title">予測完了時間</div>
    <div id="pred" class="eta">00:00:00</div>

    <!-- Wake Lock toggle -->
    <div id="wakeLine" class="wake-line">
      画面ON維持：
      <button id="wakeBtn" class="wake-btn" type="button">OFF</button>
      <span id="wakeMsg" class="wake-msg"></span>
    </div>

    <div class="divider"></div>
  </div>

  <div class="btns">
    <button id="startBtn">スタート</button>
    <button id="stopBtn" disabled>ストップ</button>
    <button id="resetBtn">リセット</button>
  </div>

</div>

<script>
(() => {
  // ===== タイマー本体 =====
  let running = false;
  let startMs = 0;
  let elapsedMs = 0;
  let timer = null;

  const elapsedEl = document.getElementById('elapsed');
  const predEl = document.getElementById('pred');
  const lotEl = document.getElementById('lotCount');
  const targetEl = document.getElementById('targetCount');

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const resetBtn = document.getElementById('resetBtn');

  // Wake Lock UI
  const wakeBtn = document.getElementById('wakeBtn');
  const wakeMsg = document.getElementById('wakeMsg');

  const pad = n => String(n).padStart(2,'0');

  function fmtHMS(ms){
    const s = Math.floor(ms/1000);
    const ss = s % 60;
    const m = Math.floor(s/60);
    const mm = m % 60;
    const hh = Math.floor(m/60);
    return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
  }

  function render(){
    const now = Date.now();
    const cur = running ? elapsedMs + (now - startMs) : elapsedMs;

    elapsedEl.textContent = fmtHMS(cur);

    const lot = Math.max(1, Number(lotEl.value) || 1);
    const target = Math.max(0, Number(targetEl.value) || 0);

    // 予測完了時間 = ceil(経過時間 × ノルマ ÷ ロット数)
    const predictedMs = Math.ceil(cur * target / lot);
    predEl.textContent = fmtHMS(predictedMs);
  }

  function start(){
    if(running) return;
    running = true;
    startMs = Date.now();
    startBtn.disabled = true;
    stopBtn.disabled = false;
    timer = setInterval(render, 200);
  }

  function stop(){
    if(!running) return;
    elapsedMs += Date.now() - startMs;
    running = false;
    clearInterval(timer);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    render();
  }

  function reset(){
    running = false;
    clearInterval(timer);
    elapsedMs = 0;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    render();
  }

  startBtn.onclick = start;
  stopBtn.onclick = stop;
  resetBtn.onclick = reset;
  lotEl.oninput = render;
  targetEl.oninput = render;

  // ===== Wake Lock（安全設計：OFFデフォ、失敗しても壊れない）=====
  let wakeSupported = ('wakeLock' in navigator);
  let wakeEnabled = false;
  let wakeLockSentinel = null;

  function setWakeUI(){
    wakeBtn.textContent = wakeEnabled ? "ON" : "OFF";
    wakeBtn.classList.toggle("on", wakeEnabled);
    if (!wakeSupported) {
      wakeMsg.textContent = "（未対応）";
      wakeBtn.disabled = true;
    } else {
      wakeBtn.disabled = false;
    }
  }

  async function requestWakeLock(){
    if (!wakeSupported) return false;
    try{
      wakeLockSentinel = await navigator.wakeLock.request('screen');

      wakeLockSentinel.addEventListener('release', () => {
        wakeLockSentinel = null;
        wakeEnabled = false;
        setWakeUI();
        wakeMsg.textContent = "（解除）";
      });

      wakeMsg.textContent = "";
      return true;
    }catch(e){
      wakeLockSentinel = null;
      wakeEnabled = false;
      setWakeUI();
      wakeMsg.textContent = "（ON不可）";
      return false;
    }
  }

  async function releaseWakeLock(){
    try{
      if (wakeLockSentinel) await wakeLockSentinel.release();
    }catch(e){
      // 無視でOK
    }finally{
      wakeLockSentinel = null;
      wakeEnabled = false;
      setWakeUI();
    }
  }

  // iOS対策：ユーザー操作でONにする
  wakeBtn.onclick = async () => {
    if (!wakeSupported) return;
    if (!wakeEnabled) {
      wakeEnabled = true;
      setWakeUI();
      await requestWakeLock();
    } else {
      await releaseWakeLock();
    }
  };

  // 画面が隠れたら解放、戻ったらONなら取り直し
  document.addEventListener('visibilitychange', async () => {
    if (!wakeSupported) return;
    if (document.visibilityState === 'hidden') {
      if (wakeLockSentinel) {
        try{ await wakeLockSentinel.release(); }catch(e){}
        wakeLockSentinel = null;
      }
    } else {
      if (wakeEnabled && !wakeLockSentinel) {
        await requestWakeLock();
      }
    }
  });

  // 初期表示
  setWakeUI();
  render();
})();
</script>

<script>
  // Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
</script>
</body>
</html>